<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tools</title>
  <link rel="stylesheet" href="../styles.css"/>

  <style>
    /* --- Coin flip --- */
    .tool-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--rule);
      background:#0b0e16;
      color:var(--text);
      cursor:pointer;
    }
    .btn:hover{ border-color: rgba(225,91,79,.35); background: rgba(225,91,79,.12); }

    .coin-wrap{ display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-top:10px; }
    .coin-stage{ perspective: 900px; }
    .coin{
      width: 86px; height: 86px;
      position: relative;
      transform-style: preserve-3d;
      border-radius: 999px;
      will-change: transform;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.35));
    }
    .coin-face{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      border-radius:999px;
      border: 2px solid rgba(255,255,255,.18);
      backface-visibility:hidden;
      user-select:none;
      font-weight: 900;
      letter-spacing:.4px;
    }
    .coin-front{
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.06) 42%, rgba(255,255,255,.02) 72%),
                  linear-gradient(180deg, rgba(225,91,79,.35), rgba(225,91,79,.10));
    }
    .coin-back{
      transform: rotateY(180deg);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.06) 42%, rgba(255,255,255,.02) 72%),
                  linear-gradient(180deg, rgba(138,180,255,.35), rgba(138,180,255,.10));
    }
    .coin-front span, .coin-back span{
      font-size: 22px;
      color: var(--text);
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
    }
    .coin-edge{
      position:absolute; inset:-2px;
      border-radius:999px;
      border: 2px solid rgba(255,255,255,.12);
      pointer-events:none;
    }

    @keyframes coinFlipHeads {
      0%   { transform: rotateY(0deg) rotateX(0deg); }
      50%  { transform: rotateY(720deg) rotateX(20deg); }
      100% { transform: rotateY(1440deg) rotateX(0deg); }
    }
    @keyframes coinFlipTails {
      0%   { transform: rotateY(0deg) rotateX(0deg); }
      50%  { transform: rotateY(720deg) rotateX(20deg); }
      100% { transform: rotateY(1620deg) rotateX(0deg); } /* +180deg to land on back */
    }

    .coin.flipping-heads{ animation: coinFlipHeads 1.05s cubic-bezier(.2,.8,.2,1); }
    .coin.flipping-tails{ animation: coinFlipTails 1.05s cubic-bezier(.2,.8,.2,1); }

    @media (prefers-reduced-motion: reduce){
      .coin.flipping-heads, .coin.flipping-tails{ animation: none; }
    }

    /* --- Cards --- */
    .cards-grid{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
    }
    .cards-list{
      margin: 8px 0 0;
      padding-left: 18px;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="title">Tools</div>
      <div class="subtitle">Random tables ‚Ä¢ encounter picker ‚Ä¢ coin flip ‚Ä¢ card draw</div>
    </div>
    <div class="top-actions">
      <a class="home-btn" href="../index.html">‚Üê Home</a>
    </div>
  </header>

  <main class="main">
    <div class="content" style="max-width:1100px;">
      <h1>Random Tables</h1>
      <div class="tool-row">
        <select id="table" class="select"></select>
        <button id="roll" class="btn">Roll</button>
      </div>
      <div id="result" style="margin-top:12px;"></div>

      <h2 style="margin-top:26px;">Encounter Picker (from your Bestiary)</h2>
      <div class="tool-row">
        <select id="cr" class="select">
          <option value="">Any CR</option>
          <option>0</option><option>1/8</option><option>1/4</option><option>1/2</option>
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
          <option>11</option><option>12</option><option>13</option><option>14</option><option>15</option>
          <option>16</option><option>17</option><option>18</option><option>19</option><option>20</option>
        </select>
        <input id="count" class="select" type="number" min="1" value="3" style="width:110px;" />
        <button id="gen" class="btn">Generate</button>
      </div>
      <div id="enc" style="margin-top:12px;"></div>

      <h2 style="margin-top:26px;">Coin Flip</h2>
      <div class="coin-wrap">
        <div class="coin-stage">
          <div id="coin" class="coin" aria-label="coin">
            <div class="coin-face coin-front"><span>HEADS</span></div>
            <div class="coin-face coin-back"><span>TAILS</span></div>
            <div class="coin-edge"></div>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <div class="tool-row">
            <button id="flip" class="btn">Flip</button>
            <button id="flip5" class="btn">Flip √ó5</button>
          </div>
          <div class="mini-box" style="margin:0;">
            <div class="mini-box-title">Result</div>
            <div class="mini-box-text">
              <div id="coinResult" class="mono">‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <h2 style="margin-top:26px;">Card Draw</h2>
      <div class="tool-row">
        <select id="deckType" class="select">
          <option value="32">32 (Skat)</option>
          <option value="52">52 (Standard)</option>
          <option value="110">110 (Romm√©)</option>
        </select>
        <input id="drawN" class="select" type="number" min="1" value="5" style="width:110px;" />
        <button id="drawBtn" class="btn">Draw</button>
        <button id="resetDeckBtn" class="btn">Reset / Shuffle</button>
      </div>

      <div class="cards-grid">
        <div class="mini-box">
          <div class="mini-box-title">Deck</div>
          <div class="mini-box-text">
            <div><b>Remaining:</b> <span id="remainingCards" class="mono">‚Äî</span></div>
            <div class="muted" style="margin-top:8px;">
              Draws are without replacement. Reset to reshuffle.
            </div>
          </div>
        </div>

        <div class="mini-box">
          <div class="mini-box-title">Last Draw</div>
          <div class="mini-box-text">
            <ul id="lastDraw" class="cards-list mono"></ul>
          </div>
        </div>

        <div class="mini-box">
          <div class="mini-box-title">Drawn So Far</div>
          <div class="mini-box-text">
            <ul id="allDrawn" class="cards-list mono"></ul>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { loadIndex, loadMany, escapeHtml } from "../lib.js";

    // ---------------- Random Tables ----------------
    const tableSel = document.getElementById("table");
    const rollBtn = document.getElementById("roll");
    const resultEl = document.getElementById("result");

    const tFiles = await loadIndex("../data/tables/index.json");
    const tables = await loadMany("../data/tables", tFiles);

    for (const t of tables){
      const opt = document.createElement("option");
      opt.value = t.name;
      opt.textContent = t.name;
      tableSel.appendChild(opt);
    }

    function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

    function roll(){
      const name = tableSel.value;
      const t = tables.find(x => x.name === name);
      if (!t || !t.entries || !t.entries.length){
        resultEl.innerHTML = `<p>No entries.</p>`;
        return;
      }
      const r = pick(t.entries);
      resultEl.innerHTML = `
        <div class="mini-box">
          <div class="mini-box-title">${escapeHtml(t.name)}${t.dice ? " ("+escapeHtml(t.dice)+")" : ""}</div>
          <div class="mini-box-text">${escapeHtml(r)}</div>
        </div>
      `;
    }
    rollBtn.addEventListener("click", roll);
    roll();

    // ---------------- Encounter Picker ----------------
    const crSel = document.getElementById("cr");
    const countEl = document.getElementById("count");
    const genBtn = document.getElementById("gen");
    const encEl = document.getElementById("enc");

    const mFiles = await loadIndex("../data/monsters/index.json");
    const monsters = await loadMany("../data/monsters", mFiles);

    function generate(){
      const cr = crSel.value;
      const n = Math.max(1, Number(countEl.value || 3));

      let pool = monsters;
      if (cr) pool = pool.filter(m => (m.challenge?.cr ?? "") === cr);

      if (!pool.length){
        encEl.innerHTML = `<p>No monsters match that filter.</p>`;
        return;
      }

      const picks = [];
      for (let i=0; i<n; i++) picks.push(pick(pool));

      encEl.innerHTML = `
        <div class="mini-box">
          <div class="mini-box-title">Encounter</div>
          <div class="mini-box-text">
            <ul>
              ${picks.map(m => `<li><b>${escapeHtml(m.name)}</b> (CR ${escapeHtml(m.challenge?.cr ?? "‚Äî")})</li>`).join("")}
            </ul>
          </div>
        </div>
      `;
    }

    genBtn.addEventListener("click", generate);
    generate();

    // ---------------- Coin Flip ----------------
    const coin = document.getElementById("coin");
    const flipBtn = document.getElementById("flip");
    const flip5Btn = document.getElementById("flip5");
    const coinResult = document.getElementById("coinResult");

    function doFlipOnce(){
      const isHeads = Math.random() < 0.5;

      // reset animation
      coin.classList.remove("flipping-heads", "flipping-tails");
      // force reflow so animation restarts
      void coin.offsetWidth;

      coin.classList.add(isHeads ? "flipping-heads" : "flipping-tails");

      // update result after animation ends
      window.setTimeout(() => {
        coinResult.textContent = isHeads ? "HEADS" : "TAILS";
      }, 1050);

      return isHeads ? "HEADS" : "TAILS";
    }

    flipBtn.addEventListener("click", () => {
      doFlipOnce();
    });

    flip5Btn.addEventListener("click", async () => {
      const results = [];
      for (let i = 0; i < 5; i++){
        results.push(doFlipOnce());
        // small delay between flips
        await new Promise(r => setTimeout(r, 1120));
      }
      coinResult.textContent = results.join(" ‚Ä¢ ");
    });

    // ---------------- Card Draw ----------------
    const deckTypeEl = document.getElementById("deckType");
    const drawNEl = document.getElementById("drawN");
    const drawBtn = document.getElementById("drawBtn");
    const resetDeckBtn = document.getElementById("resetDeckBtn");
    const remainingCardsEl = document.getElementById("remainingCards");
    const lastDrawEl = document.getElementById("lastDraw");
    const allDrawnEl = document.getElementById("allDrawn");

    let deck = [];
    let drawn = [];

    function shuffle(a){
      for (let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    const SUITS = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
    const RANKS_52 = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    const RANKS_SKAT = ["7","8","9","10","J","Q","K","A"];

    function buildDeck32(){ // true Skat: 7‚ÄìA
      const d = [];
      for (const s of SUITS){
        for (const r of RANKS_SKAT){
          d.push(`${r}${s}`);
        }
      }
      return d;
    }

    function buildDeck52(){
      const d = [];
      for (const s of SUITS){
        for (const r of RANKS_52){
          d.push(`${r}${s}`);
        }
      }
      return d;
    }

    function buildDeck110(){
      // 2 standard decks (104) + 6 jokers = 110
      const d = [];
      for (let k = 0; k < 2; k++){
        for (const s of SUITS){
          for (const r of RANKS_52){
            d.push(`${r}${s}`);
          }
        }
      }
      for (let j = 1; j <= 6; j++){
        d.push(`üÉèJOKER${j}`);
      }
      return d;
    }

    function resetDeck(){
      const t = deckTypeEl.value;
      if (t === "110") deck = buildDeck110();
      else if (t === "32") deck = buildDeck32();
      else deck = buildDeck52();

      shuffle(deck);
      drawn = [];
      renderDeckUI([], true);
    }

    function renderList(el, cards){
      el.innerHTML = cards.map(c => `<li>${escapeHtml(c.replace(/^üÉèJOKER\d+$/,"üÉèJOKER"))}</li>`).join("");
    }

    function renderDeckUI(last, justReset=false){
      remainingCardsEl.textContent = String(deck.length);
      renderList(lastDrawEl, last);
      renderList(allDrawnEl, drawn);
      if (justReset){
        lastDrawEl.innerHTML = "";
        allDrawnEl.innerHTML = "";
      }
    }

    function drawCards(){
      const n = Math.max(1, Number(drawNEl.value || 1));
      if (deck.length === 0){
        renderDeckUI([]);
        lastDrawEl.innerHTML = "<li>(deck empty)</li>";
        return;
      }

      const take = Math.min(n, deck.length);
      const pulled = deck.splice(0, take);
      drawn.push(...pulled);
      renderDeckUI(pulled);
    }

    deckTypeEl.addEventListener("change", resetDeck);
    resetDeckBtn.addEventListener("click", resetDeck);
    drawBtn.addEventListener("click", drawCards);

    resetDeck();
  </script>
</body>
</html>